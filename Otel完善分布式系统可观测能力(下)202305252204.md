# OpenTelemetry--<br>完善分布式系统可观测能力（下）

<font size=2>演讲人：梁伟斌							日期：2023.05.31</font>



## 一、上节回顾

* <u>什么是分布式系统可观测能力？</u>

  通过收集分布式系统的表层信息了解其内部状态，而不必对内部每个服务进行分拆分析。

* <u>什么是OpenTelemetry？</u>

  由一系列工具、API和SDK组成的开源可观测能力框架。

* <u>OpenTelemetry数据模型？</u>

  > Traces（分布式链路追踪）
  >
  > > Span（跨度）
  > >
  > > Resource（静态上下文）
  > >
  > > Event（事件）
  >
  > Metrics（指标）
  >
  > > Gauges（度量）
  > >
  > > Counters（计数器）
  > >
  > > Histograms（直方图）
  > >
  > > Meters（速率计算器）
  > >
  > > Timers（计时器）
  >
  > Logs（日志）
  >
  > Baggage（键值对包袱）
  >
  > Context Propagation（上下文传播）

* <u>OpenTelemetry Library？</u>

  > API
  >
  > SDK
  >
  > Semantic Convertions（语义约定）
  >
  > Collector（收集器）
  >
  > Exporter（导出器）

* <u>OpenTelemetry Collection？</u>

<img src="\OtelCollection.png" />



## 二、项目演示

### 1.项目中间组件预准备

#### rabbitmq

镜像：

```shell
docker pull rabbitmq:latest
```

启动rabbitmq镜像：

```shell
docker run -d --hostname rabbitmq --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:latest
```

启动rabbitmq UI插件（15672端口）：

```shell
docker exec -it 7431154083d6 /bin/bash
rabbitmq-plugins enable rabbitmq_management
```

#### jaeger

镜像：

```shell
docker pull jaegertracing/all-in-one:latest
```

启动jaeger（UI端口：16686）：

```shell
docker run -d --name jaeger \
  -e COLLECTOR_ZIPKIN_HOST_PORT=:9411 \
  -e COLLECTOR_OTLP_ENABLED=true \
  -p 6831:6831/udp \
  -p 6832:6832/udp \
  -p 5778:5778 \
  -p 16686:16686 \
  -p 4317:4317 \
  -p 4318:4318 \
  -p 14250:14250 \
  -p 14268:14268 \
  -p 14269:14269 \
  -p 9411:9411 \
  jaegertracing/all-in-one:latest
```

#### prometheus

镜像：

```shell
docker pull prom/prometheus:latest
```

配置文件/volume/prometheus/prometheus.yml：

```yaml
global:
  scrape_interval: 3s
  evaluation_interval: 3s
scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["192.168.5.216:13901"]
```

启动prometheus（UI端口9090）：

```shell
docker run -d \
    -p 9090:9090 \
    -v /volume/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus:latest
```



2.jaeger演示图

<img src="\jaeger1.png" /> 

<img src="\jaeger2.png" />



## 三、.net框架原生分布式跟踪和指标

### 1.分布式链路追踪-ActivitySource类

命名空间：System.Diagnostics

程序集：System.Diagnostics.DiagnosticSource.dll

提供 API 来创建和启动 Activity 对象，以及注册 ActivityListener 对象来侦听 Activity 事件。

### 2.跨度-Activity类

命名空间：System.Diagnostics

程序集：System.Diagnostics.DiagnosticSource.dll

表示具有要用于日志记录的上下文的操作。

```c#
internal class Program
{
    static ActivitySource s_source = new ActivitySource("com.syc.cms", "v1.0.0");
    static void Main(string[] args)
    {
        ActivitySource.AddActivityListener(new ActivityListener
        {
            ShouldListenTo = source => source.Name.Equals("com.syc.cms"),
            Sample = (ref ActivityCreationOptions<ActivityContext> options) => ActivitySamplingResult.AllDataAndRecorded,
            ActivityStarted = activity => Console.WriteLine($"Start:{activity.DisplayName}"),
            ActivityStopped = activity => Console.WriteLine($"End:{activity.DisplayName}")
        });

        using (Activity? activity = s_source.StartActivity("DataCollection"))
        {
            #region Data collection execution.

            #endregion
            using (Activity? subActivity = s_source.StartActivity("DataAnalysis"))
            {
                #region Data analysis execution.

                #endregion
            }
        }
    }
}
```

### 3.指标-Meter类

命名空间：System.Diagnostics.Metrics

程序集：System.Diagnostics.DiagnosticSource.dll

计量是负责创建和跟踪 Instruments 的类。

```c#
internal class Program
{
    static Meter s_meter = new Meter("com.syc.cms", "v1.0.0");
    static Counter<int> s_collectionNum = s_meter.CreateCounter<int>("collectionNum");
    static Program() { }
    static void Main(string[] args)
    {
        using (MeterListener listener = new MeterListener())
        {
            listener.InstrumentPublished = (instrument, listener) =>
            {
                if (instrument.Meter.Name == "com.syc.cms")
                {
                    listener.EnableMeasurementEvents(instrument);
                }
            };
            listener.SetMeasurementEventCallback<int>((Instrument instrument, int measurement, ReadOnlySpan<KeyValuePair<string, object?>> tags, object? state) =>
            {
                Console.WriteLine($"Name:{instrument.Name}, Value:{measurement}");
            });
            listener.Start();
        }

        while (true)
        {
            s_collectionNum.Add(Random.Shared.Next(1,100));
            Thread.Sleep(100);
        }
    }
}
```



## 四、OpenTelemetry分布式跟踪和指标

